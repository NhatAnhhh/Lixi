<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thá»•i LÃ¬ XÃ¬ & Quáº» Kinh Dá»‹ch</title>
    <style>
        body { font-family: Arial; text-align: center; background: #f8d7da; color: #721c24; padding: 20px; }
        #input-section { margin: 20px; }
        #blow-area { margin: 30px; }
        #envelope { font-size: 100px; transition: transform 0.3s; }
        #progress { width: 80%; height: 20px; background: #ddd; margin: 20px auto; border-radius: 10px; overflow: hidden; }
        #progress-bar { height: 100%; width: 0%; background: linear-gradient(to right, #ff6b6b, #ffcc00); transition: width 0.2s; }
        #result { font-size: 24px; display: none; margin-top: 40px; }
        button { padding: 15px 30px; font-size: 20px; background: #dc3545; color: white; border: none; border-radius: 10px; }
    </style>
</head>
<body>
    <h1>Thá»•i LÃ¬ XÃ¬ Táº¿t & Quáº» Kinh Dá»‹ch</h1>
    <div id="input-section">
        <label>Nháº­p tÃªn báº¡n:</label><br>
        <input type="text" id="name" placeholder="VÃ­ dá»¥: Thanh"><br><br>
        <button id="startBtn">Báº¯t Ä‘áº§u thá»•i!</button>
    </div>

    <div id="blow-area" style="display:none;">
        <div id="envelope">ðŸ§§</div> <!-- Icon bao lÃ¬ xÃ¬, cÃ³ thá»ƒ thay báº±ng hÃ¬nh -->
        <p>Giá»¯ nÃºt dÆ°á»›i vÃ  **thá»•i máº¡nh** vÃ o mic!</p>
        <button id="blowBtn">Giá»¯ Ä‘á»ƒ thá»•i</button>
        <div id="progress"><div id="progress-bar"></div></div>
    </div>

    <div id="result"></div>

    <script>
        const liXiOptions = [30000, 30000, 30000, 30000, 50000, 50000, 50000, 100000, 100000, 200000];
        const hexagrams = [ /* Giá»¯ nguyÃªn array 64 quáº» tá»« code cÅ© */ 
            // ... paste full array hexagrams á»Ÿ Ä‘Ã¢y ...
        ];

        let audioContext, analyser, stream, scriptProcessor;
        let blowProgress = 0;
        let blowThreshold = -45; // dB, Ä‘iá»u chá»‰nh theo test (tháº¥p hÆ¡n = dá»… thá»•i hÆ¡n)
        let isBlowing = false;
        let blowTimer;

        const nameInput = document.getElementById('name');
        const startBtn = document.getElementById('startBtn');
        const blowBtn = document.getElementById('blowBtn');
        const blowArea = document.getElementById('blow-area');
        const progressBar = document.getElementById('progress-bar');
        const resultDiv = document.getElementById('result');
        const envelope = document.getElementById('envelope');

        startBtn.onclick = async () => {
            const name = nameInput.value.trim();
            if (!name) return alert('Nháº­p tÃªn nhÃ©!');
            document.getElementById('input-section').style.display = 'none';
            blowArea.style.display = 'block';
        };

        blowBtn.onmousedown = blowBtn.ontouchstart = async (e) => {
            e.preventDefault();
            isBlowing = true;
            blowProgress = 0;
            envelope.style.transform = 'scale(1)';
            try {
                if (!stream) {
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaStreamSource(stream);
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 2048;
                    source.connect(analyser);
                    scriptProcessor = audioContext.createScriptProcessor(2048, 1, 1);
                    analyser.connect(scriptProcessor);
                    scriptProcessor.connect(audioContext.destination);
                    scriptProcessor.onaudioprocess = processAudio;
                }
                blowTimer = setInterval(updateBlow, 200);
            } catch (err) {
                alert('KhÃ´ng truy cáº­p Ä‘Æ°á»£c mic! HÃ£y cho phÃ©p vÃ  thá»­ láº¡i.');
                isBlowing = false;
            }
        };

        blowBtn.onmouseup = blowBtn.ontouchend = () => {
            isBlowing = false;
            clearInterval(blowTimer);
            blowProgress = 0;
            progressBar.style.width = '0%';
            envelope.style.transform = 'scale(1)';
        };

        function processAudio() {
            if (!isBlowing) return;
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for (let val of dataArray) sum += val;
            const avg = sum / dataArray.length;
            const volume = 20 * Math.log10(avg / 255) || -100; // approx dB
            if (volume > blowThreshold) {
                blowProgress += (volume + 100) / 10; // tÄƒng progress khi volume cao
                blowProgress = Math.min(blowProgress, 100);
            }
        }

        function updateBlow() {
            progressBar.style.width = blowProgress + '%';
            envelope.style.transform = `scale(${1 + blowProgress / 200})`; // phá»“ng lÃªn
            if (blowProgress >= 100) {
                isBlowing = false;
                clearInterval(blowTimer);
                generateResult();
            }
        }

        function generateResult() {
            const name = nameInput.value.trim();
            const liXi = liXiOptions[Math.floor(Math.random() * liXiOptions.length)];
            const hex = hexagrams[Math.floor(Math.random() * hexagrams.length)];
            resultDiv.innerHTML = `
                <h2>ChÃºc má»«ng ${name}!</h2>
                <h2>LÃ¬ xÃ¬: ${liXi.toLocaleString('vi-VN')} VND ðŸ§§</h2>
                <h3>Quáº»: Sá»‘ ${hex.number} - ${hex.chinese} (${hex.english})</h3>
                <p>ChÃº giáº£i: ${hex.desc}</p>
                <button onclick="location.reload()">Thá»•i láº¡i</button>
            `;
            resultDiv.style.display = 'block';
            blowArea.style.display = 'none';
            // Dá»«ng mic náº¿u muá»‘n: stream.getTracks().forEach(track => track.stop());
        }
    </script>
</body>
</html>